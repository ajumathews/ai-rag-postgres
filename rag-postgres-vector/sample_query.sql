WITH embedding_value AS (
    SELECT '[0.0014706552028656006, 1.5981471538543701, -3.4888453483581543, 0.09222885966300964, 0.5408409833908081, 0.025891076773405075, -0.36377522349357605, -1.214634895324707, -0.7910175323486328, 0.5073308944702148, 1.4222424030303955, 1.0892601013183594, 0.5227252840995789, 1.425033688545227, -0.8962209820747375, 1.4240387678146362, -1.614548683166504, -0.05170601233839989, -0.5349315404891968, 0.27373790740966797, -0.7355458736419678, -0.5812190771102905, -1.4642945528030396, -0.23483127355575562, 1.388918161392212, 0.8259474635124207, -0.8995746970176697, 0.1100003644824028, -0.3108444809913635, 0.6551622748374939, 1.500715970993042, -0.6354897022247314, -0.3355874717235565, -2.017444372177124, 0.6896280646324158, -0.6691030263900757, 1.6838017702102661, -0.2340508997440338, 0.6397024989128113, 0.8371512293815613, 0.389807790517807, -1.0799839496612549, 0.5766026377677917, 0.7092938423156738, 0.7480862140655518, -0.18532618880271912, 0.3588630259037018, 0.5065378546714783, 0.9196543097496033, -0.21821048855781555, 1.0407805442810059, 0.6403079628944397, -0.3218049705028534, -1.9342176914215088, 0.08023488521575928, 0.29961907863616943, -0.5950452089309692, 0.6910449862480164, -0.7821009159088135, -0.6182757616043091, 1.6992781162261963, 1.164997935295105, -0.044377341866493225, 1.2110028266906738, 0.8452268838882446, -1.4439749717712402, -0.5152171850204468, 0.557045578956604, -0.705824613571167, -0.23011186718940735, 0.2869202494621277, 0.2556232810020447, 1.3254523277282715, 0.21282684803009033, 0.08353126794099808, -0.9534071087837219, -0.48912811279296875, -1.031144618988037, -0.5006120800971985, 0.9656456112861633, 0.9379373788833618, 0.2685607671737671, 0.5809279680252075, -0.4295785427093506, 1.8851505517959595, 0.2276962399482727, -0.04630234092473984, -0.21443429589271545, -1.0235146284103394, 0.7107142210006714, 0.6756414175033569, 1.6243798732757568, 0.7734051942825317, 0.5111512541770935, -0.2941078543663025, 0.42714250087738037, -0.07480493187904358, 0.5092962980270386, -0.3126005232334137, -1.3143666982650757, 0.30891650915145874, -0.14855718612670898, 0.7202799916267395, -1.037347674369812, 1.6886347532272339, 0.6263735294342041, 0.5184974074363708, 0.5436685085296631, -0.34080320596694946, -0.5402588248252869, -0.019788891077041626, 0.49548882246017456, -0.3578850030899048, -0.8888145089149475, -0.020842360332608223, 0.17427939176559448, -0.2630029618740082, -0.9743305444717407, 0.7022418975830078, 1.5941309928894043, -1.1376488208770752, -0.3438708484172821, -0.22509276866912842, 0.8793438076972961, 0.7676849961280823, -0.23492993414402008, -0.7919395565986633, -0.7619650363922119, 0.8749167919158936, 0.44168728590011597, 0.22595129907131195, -0.8548526763916016, -0.3949410617351532, 0.8092132210731506, 0.0008404552936553955, 1.2491867542266846, -0.5600234270095825, 0.24556691944599152, 0.9411031007766724, 1.0945823192596436, -0.6249781250953674, -0.29015785455703735, -0.7626667022705078, -0.40769296884536743, 0.5191535949707031, -1.422381043434143, 0.4524162709712982, 0.41255664825439453, -0.25497904419898987, -0.4386895000934601, -1.1798784732818604, 0.18396031856536865, 0.7853585481643677, 0.25680506229400635, 0.8043923377990723, -0.6869122982025146, -0.05241768807172775, 0.21429036557674408, -0.5265225172042847, -0.6961119174957275, 1.135874629020691, 0.005156274884939194, -0.7329297065734863, 1.2839223146438599, -0.5024769902229309, -2.0363893508911133, 0.6471800208091736, 0.6931013464927673, 0.7506439089775085, 1.466055989265442, -2.2486491203308105, -0.22411710023880005, -0.9565824866294861, -0.16746243834495544, 1.1882888078689575, 0.35515326261520386, -0.04563136398792267, -0.28549516201019287, 0.4255215525627136, -0.9364956021308899, -0.42788001894950867, -0.1367759257555008, -0.397990345954895, 0.7655165791511536, 0.21313072741031647, -0.11761362105607986, -0.35219308733940125, -0.21055957674980164, -0.5543099641799927, 0.8965311646461487, 0.21799977123737335, 2.142958641052246, -1.3873311281204224, -1.9930609464645386, -0.5607014298439026, 0.5586951971054077, 0.24189186096191406, 0.9279569983482361, 0.9356595277786255, -0.5195733904838562, -0.7504728436470032, -0.854468584060669, -1.2527928352355957, -0.20715640485286713, -1.304783582687378, 0.5815463066101074, 0.5108262300491333, 1.0991623401641846, -0.037214212119579315, 0.25682011246681213, -0.2778177261352539, -0.18961285054683685, 0.2753608524799347, -0.39428868889808655, 0.6724961996078491, -1.0311880111694336, -0.3041572868824005, -1.221437931060791, -0.7986879348754883, 0.9886996746063232, 1.7244198322296143, -0.37416309118270874, 0.43747708201408386, 0.7384964227676392, 1.2098214626312256, 0.0811510980129242, -1.4152255058288574, -0.7714353203773499, -0.3668687641620636, 0.6794177889823914, -0.19478903710842133, -0.7304759621620178, 1.3238580226898193, 0.4476904273033142, 0.26829007267951965, 0.21353085339069366, -0.765119731426239, 0.4908578395843506, 0.8409952521324158, 0.865736186504364, 0.879210352897644, 1.0643572807312012, -0.2867940068244934, -0.2475845068693161, -0.8994889259338379, -0.4915193021297455, -1.7507768869400024, -0.9910238981246948, -0.4729076325893402, 1.143733024597168, 0.29350510239601135, 0.0666787400841713, 0.014426223933696747, 1.1431069374084473, 0.5549089312553406, -0.2379508763551712, -0.9005967378616333, -0.7986698746681213, 0.769880473613739, -0.6349124908447266, -0.30081310868263245, 0.29535868763923645, -0.9049267172813416, -0.50311279296875, 0.8439376354217529, 0.6803849339485168, 0.5983311533927917, -0.8754996657371521, 0.7272616028785706, 0.08856316655874252, 0.5145076513290405, 0.23715847730636597, -0.14857177436351776, 0.35330137610435486, 0.3566034138202667, -0.009998898953199387, 0.6834100484848022, 0.9173362851142883, -1.3906368017196655, 1.2418993711471558, -0.4330763816833496, -1.9638404846191406, -1.054308295249939, 0.2646922171115875, -0.39616715908050537, 0.8325586318969727, 0.9575293064117432, -1.1065672636032104, 0.4607278108596802, 0.5324866771697998, -0.01001008227467537, 0.04325209558010101, 0.6378703713417053, -0.10844804346561432, -0.4755589962005615, -0.27314403653144836, 1.3015938997268677, 0.4071001410484314, 0.26765480637550354, -0.6800488829612732, -0.34567663073539734, 0.21892203390598297, 1.4134221076965332, 1.0357162952423096, -0.36431068181991577, -1.292405366897583, -0.33396828174591064, -0.9191820621490479, 0.4343283176422119, -0.5520274043083191, -0.7118031978607178, -0.7025207281112671, 0.09383441507816315, 0.6439956426620483, -0.018937088549137115, 0.11129780113697052, -0.2547052800655365, 0.26500213146209717, 0.7467705607414246, 0.6063299775123596, -0.36173906922340393, -0.5784262418746948, -0.6911086440086365, -0.5992555022239685, -0.8988719582557678, 0.892890453338623, 0.5269583463668823, -0.17522306740283966, 1.1943609714508057, 0.6047977805137634, 0.049298517405986786, 0.7194816470146179, -0.22475117444992065, 0.24820080399513245, 0.31606850028038025, 0.0678328275680542, -0.0884707123041153, 0.3713395893573761, -0.23141545057296753, 0.1549062579870224, 0.7148300409317017, -0.7794684171676636, 0.6889364123344421, -0.5125434398651123, -0.3196299374103546, -0.3029056787490845, 0.1086755096912384, -0.8956065773963928, -0.21260978281497955, -0.05247710645198822, -0.9673458933830261, -0.5685375332832336, 0.17115990817546844, -0.6085442900657654, 0.0702027827501297, -0.17101061344146729, -0.21085156500339508, 0.048704151064157486, 1.298224925994873, -0.1899833083152771, 0.1748742312192917, 0.5480055212974548, -0.23266926407814026, -0.9303891658782959, 0.09715393930673599, 0.18792136013507843, -0.43251311779022217, 0.9861421585083008, 0.9336740374565125, -0.5042915940284729, 0.11945125460624695, 0.2059880793094635, 0.3638398051261902, 0.773622453212738, -0.4001654088497162, 0.40145301818847656, -1.1419053077697754, -1.3887208700180054, 0.42309388518333435, 0.3128190040588379, 0.2855488657951355, -1.2120575904846191, -0.02547322027385235, 0.39510205388069153, -0.4854446053504944, -0.2818363308906555, 0.3439498543739319, -0.4598139822483063, -0.2328568398952484, -0.4064951539039612, -0.36848360300064087, -1.2302511930465698, -1.138702630996704, 0.06572810560464859, 0.16626444458961487, -0.5636493563652039, 0.4782153367996216, -1.1346397399902344, 0.49786272644996643, -0.31272244453430176, 0.09470684081315994, 0.0587635338306427, 0.4317047894001007, -0.5394382476806641, 0.6193062663078308, -0.706904947757721, -0.9695438146591187, -1.2516924142837524, 0.823616623878479, 0.7086164951324463, -0.5082956552505493, 0.5238849520683289, 1.2572985887527466, -1.928917407989502, 0.9874229431152344, 1.7845627069473267, -0.12961767613887787, -0.06362830847501755, -0.9638164639472961, 1.07656991481781, 0.2833373248577118, 0.8057485222816467, -0.40180230140686035, 0.39794856309890747, -0.41005465388298035, 0.45147043466567993, 0.6644493341445923, 0.7032485008239746, -0.18368744850158691, -0.8263397812843323, 0.3000645935535431, -0.3345012366771698, 1.2231957912445068, -0.4149050712585449, -0.2439485490322113, 0.34366682171821594, -0.257006973028183, 0.32636868953704834, 0.7085282802581787, 0.7045015096664429, 0.4509286880493164, -0.44132182002067566, 0.7813509106636047, -0.823570966720581, -0.12913642823696136, 2.660471200942993, 1.3784228563308716, -0.5036957263946533, -0.2948797643184662, 0.32654452323913574, 0.03306932747364044, -0.5075225830078125, 0.04038756713271141, 0.6049806475639343, 0.7284563183784485, -1.2653735876083374, -0.768541157245636, 0.09388483315706253, 1.018943190574646, 0.6350942850112915, 0.8324618339538574, 1.009137749671936, -0.7149697542190552, 0.3473886251449585, -0.41919076442718506, -0.8313323259353638, -0.011647059582173824, 0.695500373840332, 0.635796844959259, 0.08217252790927887, 0.010487545281648636, -0.04431116208434105, 1.0040647983551025, 0.3471463918685913, -0.7340693473815918, 0.0915670245885849, 0.2151203751564026, -0.24043038487434387, 0.35353344678878784, 1.2014641761779785, 0.631195604801178, -0.22706374526023865, -0.05822916701436043, -1.0976096391677856, 0.7022481560707092, 1.538761854171753, -0.5188409686088562, 0.1721038818359375, 0.8043017387390137, -0.1324359029531479, -0.11032979190349579, -0.597612738609314, 0.12655329704284668, 0.8095812201499939, -0.3544771373271942, -0.19468750059604645, 0.15375737845897675, -0.92970210313797, 0.41880255937576294, 0.1295217126607895, 0.10231252014636993, 1.6039509773254395, 0.25717025995254517, -1.0055124759674072, 0.9192752838134766, -0.15942609310150146, 0.645229697227478, -1.5223991870880127, -0.20006954669952393, 0.6614001989364624, -1.1459742784500122, 0.25341394543647766, 1.1004796028137207, 0.20335635542869568, 0.3011668920516968, -1.7049994468688965, 0.19763116538524628, -0.6477410197257996, -1.4437140226364136, -0.04130435362458229, 1.027343511581421, -1.1800906658172607, 0.01799900457262993, 0.936129629611969, -1.2830322980880737, 0.9973994493484497, 1.0286896228790283, -1.6940891742706299, 1.254681944847107, 0.25118717551231384, 0.18844807147979736, -0.08281131088733673, -2.553393840789795, -0.5337020754814148, -0.42101654410362244, -0.9071217179298401, -0.3310066759586334, 0.6340700387954712, 1.0935255289077759, 0.008773241192102432, 0.48392215371131897, -0.20774945616722107, -0.06490499526262283, 1.4314613342285156, -0.6154773235321045, 0.013611391186714172, -0.6196216940879822, 0.9552828073501587, -0.1088358461856842, -1.382204294204712, 0.4675605297088623, -1.3535937070846558, 0.2505459189414978, -0.6131020784378052, 0.7793627381324768, -0.2054682970046997, -0.3462924063205719, -0.4557785987854004, -0.6387543082237244, -0.346699059009552, 0.8659290671348572, -0.30439531803131104, 0.9726794362068176, -0.3504180312156677, -0.6282905340194702, 0.36264002323150635, 0.3688204884529114, 0.04741816595196724, 0.344392329454422, -0.8347058892250061, 0.8682264089584351, -1.8695240020751953, 0.4677255153656006, -0.6690104007720947, 0.28563207387924194, -0.7726082801818848, 0.2793247699737549, 0.5994144082069397, -1.541835904121399, -1.1514376401901245, 0.13877293467521667, -0.973965048789978, -0.22940489649772644, 1.3847038745880127, 0.7991409301757812, 0.3438337743282318, -0.6124650239944458, -0.14950275421142578, 0.10486526787281036, -0.28713566064834595, -0.5319037437438965, -0.6299525499343872, 0.43433505296707153, 0.43463554978370667, -0.6555353999137878, 0.7723014950752258, -0.5942881107330322, 0.37698841094970703, 0.1742967665195465, -1.3458788394927979, 0.3137110471725464, 0.6889201402664185, 0.34022682905197144, -1.4985783100128174, -0.7380549907684326, 0.1342051774263382, -0.4047950804233551, 0.07518230378627777, 0.11773603409528732, -1.190704345703125, 0.8028703927993774, 0.1938200294971466, -0.02671121247112751, -0.8578107953071594, 0.5844655632972717, -0.7208043336868286, 0.41974523663520813, -1.1084634065628052, -0.09743379056453705, -0.7772049903869629, -0.06536278128623962, -1.7977508306503296, 0.39673030376434326, -0.8131808638572693, 0.37518468499183655, -0.07596468180418015, -1.7304511070251465, -0.40452978014945984, 2.258150815963745, 0.8996878266334534, 0.27027103304862976, -0.31250450015068054, -0.8881782293319702, -0.9086428880691528, 0.36115339398384094, -0.1441679298877716, 0.1570129096508026, 0.16921095550060272, 0.7414262890815735, 0.08516784012317657, 0.0027789846062660217, -0.6932060122489929, -0.0048585631884634495, -0.776694655418396, 1.213602066040039, 0.08576038479804993, -0.35711634159088135, -0.5291020274162292, 0.3780216574668884, 0.2817504107952118, 1.4318557977676392, 1.3944249153137207, 0.5410069227218628, -0.02794468402862549, -0.3055225610733032, -0.2300414890050888, -0.3107526898384094, -0.4837174117565155, -0.051225800067186356, -1.7138242721557617, -0.46920397877693176, 0.4017135500907898, -0.8525478839874268, 0.6508434414863586, 0.25874969363212585, -0.3913877010345459, -0.47420766949653625, 0.030561765655875206, -1.3224796056747437, 0.17973245680332184, -0.2878590226173401, 0.23617038130760193, -0.3559107184410095, 0.9382566213607788, -1.084917664527893, 0.9803047180175781, 0.5272828936576843, 0.6151566505432129, 0.0950138121843338, -0.7171172499656677, -0.9605477452278137, -1.5706003904342651, 0.810897171497345, 0.3869660794734955, 0.3278372585773468, -1.1447025537490845, 0.8746418356895447, -0.18659773468971252, -0.07237709313631058, -1.4508726596832275, 0.8047310709953308, -0.9020586609840393, -0.07647273689508438, 0.47604474425315857, -0.3540889024734497, 0.04091333597898483, -0.37409698963165283, -0.3193342983722687, -0.7727248072624207, -0.1588687151670456, -0.33723586797714233, 0.9609503746032715, 1.0026118755340576, 1.2148120403289795, -1.0710740089416504, -0.7252106666564941, 0.8656743764877319, -0.6679052710533142, 1.0157158374786377, 1.1589511632919312, -0.9078826904296875, -1.143850564956665, 0.13769769668579102, 1.1210418939590454, 1.8161779642105103, -0.5144474506378174, 0.33831679821014404, -2.433408260345459, -1.0814706087112427, 1.2489697933197021, 1.2719759941101074, 0.19889619946479797, 0.03695528209209442, -0.8579496145248413, 0.15471996366977692, -0.2972225248813629, 0.4974471926689148, -0.7442685961723328, 1.0089335441589355, -0.6014693975448608, 0.05733545497059822, 0.4225734770298004, 0.2951586842536926, 1.6740171909332275, 0.1384090781211853, -1.0467395782470703, -0.7738760709762573, -0.9530948996543884, -1.0918166637420654, -0.2640654742717743, -0.7930328845977783, 0.4982025623321533, -0.3324158489704132, 0.7922602891921997, 0.4308551847934723, 0.11733373999595642, -0.3385811150074005, -0.37181565165519714, 0.9210917949676514, 0.23664391040802002, -0.08523108810186386, -1.10595703125, -0.6776163578033447, -0.6228740215301514, 0.6800141334533691, 0.30315089225769043, -0.20920273661613464, 0.8699547648429871, 2.3531625270843506, 0.3876158893108368, -0.07653352618217468, -0.7099260091781616, 0.8067017793655396, 1.172249674797058, -0.13303709030151367, -0.3981226086616516, -1.7877224683761597, -0.05645085871219635]'::vector AS emb
)
,vector_search AS(
SELECT pe.product_id, 
       RANK() OVER (ORDER BY pe.embedding <=> e.emb) AS rank
FROM product_embeddings pe, embedding_value e
ORDER BY pe.embedding <=> e.emb
LIMIT 20
)
--select * from vector_search

,fulltext_search AS(
SELECT product_id, RANK () OVER (ORDER BY ts_rank_cd(to_tsvector('english', product_description), query) DESC)
  FROM products, plainto_tsquery('english', 'laptops with nvidia graphics') query
  WHERE to_tsvector('english', product_description) @@ query
  ORDER BY ts_rank_cd(to_tsvector('english', product_description), query) DESC
  LIMIT 20
)

--select * from fulltext_search

,hybrid_search AS(
SELECT
  COALESCE(vector_search.product_id, fulltext_search.product_id) AS product_id,
  COALESCE(1.0 / (60 + vector_search.rank), 0.0) +
  COALESCE(1.0 / (60 + fulltext_search.rank), 0.0) AS score
FROM vector_search
FULL OUTER JOIN fulltext_search ON vector_search.product_id = fulltext_search.product_id
ORDER BY score DESC
LIMIT 20
)

select p.product_id, p.product_name, p.product_description, hs.score from hybrid_search hs
join products p on hs.product_id = p.product_id
order by hs.score desc







